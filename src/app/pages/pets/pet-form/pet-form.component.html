<div class="pet-form flex flex-col min-h-[calc(100vh-5rem)]">
  <div class="flex-1 bg-petrack-pale">
    <div class="max-w-xl mx-auto px-3 sm:px-4 py-6 sm:py-8">
      <a
        routerLink="/pets"
        class="inline-flex items-center gap-2 text-gray-600 hover:text-petrack mb-6"
      >
        <lucide-icon name="arrow-left" [size]="20" />
        Voltar aos Pets
      </a>

      <h1 class="text-2xl font-bold text-petrack-dark mb-6">{{ title() }}</h1>

      @if (error$ | async; as error) {
        <div class="mb-4 p-3 rounded-xl bg-red-50 border border-red-200 text-red-700 text-sm">
          {{ error }}
        </div>
      }

      <form (ngSubmit)="onSubmit()" class="bg-white rounded-xl shadow-md border border-gray-100 p-4 sm:p-6 space-y-4">
        @if (isEdit() && petId() !== null) {
          <div class="pb-4 border-b border-gray-100">
            <label class="block text-sm font-medium text-gray-700 mb-2">Foto do pet</label>
            <div class="flex flex-wrap items-center gap-4">
              @if (selectedPet$ | async; as pet) {
                @if (pet.foto?.url) {
                  <img [src]="pet.foto?.url" [alt]="pet.nome ?? 'Pet'" class="w-20 h-20 rounded-xl object-cover border border-gray-200" />
                }
              }
              <label
                class="inline-flex items-center gap-2 px-4 py-2.5 rounded-xl border border-gray-200 bg-gray-50 text-gray-700 cursor-pointer hover:bg-gray-100"
              >
                <lucide-icon name="camera" [size]="18" />
                <span>{{ (selectedPet$ | async)?.foto?.url ? 'Alterar foto' : 'Enviar foto' }}</span>
                <input
                  type="file"
                  accept="image/*"
                  class="hidden"
                  (change)="onPhotoSelected($event)"
                />
              </label>
            </div>
          </div>
        }
        <div>
          <label for="nome" class="block text-sm font-medium text-gray-700 mb-1">Nome</label>
          <input
            id="nome"
            type="text"
            [(ngModel)]="nome"
            name="nome"
            class="w-full px-4 py-2.5 rounded-xl border border-gray-200 focus:ring-2 focus:ring-petrack-light focus:border-petrack"
            placeholder="Nome do pet"
          />
        </div>
        <div>
          <label for="raca" class="block text-sm font-medium text-gray-700 mb-1">Raça</label>
          <input
            id="raca"
            type="text"
            [(ngModel)]="raca"
            name="raca"
            class="w-full px-4 py-2.5 rounded-xl border border-gray-200 focus:ring-2 focus:ring-petrack-light focus:border-petrack"
            placeholder="Raça"
          />
        </div>
        <div>
          <label for="idade" class="block text-sm font-medium text-gray-700 mb-1">Idade (anos)</label>
          <input
            id="idade"
            type="text"
            [(ngModel)]="idade"
            name="idade"
            class="w-full px-4 py-2.5 rounded-xl border border-gray-200 focus:ring-2 focus:ring-petrack-light focus:border-petrack"
            placeholder="Ex: 3"
          />
        </div>
        <div class="relative">
          <label for="tutorSearch" class="block text-sm font-medium text-gray-700 mb-1">Tutor (opcional)</label>
          <div class="relative">
            <input
              id="tutorSearch"
              type="text"
              [ngModel]="tutorSearchInput"
              (ngModelChange)="onTutorSearchChange($event)"
              (blur)="onTutorSearchBlur()"
              name="tutorSearch"
              autocomplete="off"
              class="w-full px-4 py-2.5 pr-20 rounded-xl border border-gray-200 focus:ring-2 focus:ring-petrack-light focus:border-petrack"
              placeholder="Digite o nome do tutor para buscar"
            />
            @if (tutoresLoading) {
              <span
                class="absolute right-3 top-1/2 -translate-y-1/2 flex items-center gap-1.5 text-gray-500 text-sm"
                aria-hidden="true"
              >
                <lucide-icon name="loader" [size]="18" class="animate-spin" />
                <span class="text-xs">Buscando...</span>
              </span>
            } @else if (selectedTutor) {
              <button
                type="button"
                (click)="clearTutor()"
                class="absolute right-2 top-1/2 -translate-y-1/2 p-1.5 rounded-lg text-gray-400 hover:text-gray-600 hover:bg-gray-100"
                title="Limpar tutor"
              >
                <lucide-icon name="x" [size]="18" />
              </button>
            }
          </div>
          @if (tutorDropdownOpen && tutoresOptions.length > 0) {
            <ul
              class="absolute z-10 w-full mt-1 py-1 bg-white border border-gray-200 rounded-xl shadow-lg max-h-60 overflow-auto"
            >
              @for (t of tutoresOptions; track t.id) {
                <li>
                  <button
                    type="button"
                    (click)="selectTutor(t)"
                    class="w-full text-left px-4 py-2.5 hover:bg-petrack-pale text-gray-800 text-sm"
                  >
                    <span class="font-medium">{{ t.nome }}</span>
                    @if (t.telefone || t.email) {
                      <span class="text-gray-500 text-xs block mt-0.5">{{ t.telefone || t.email }}</span>
                    }
                  </button>
                </li>
              }
            </ul>
          }
          @if (tutorDropdownOpen && !tutoresLoading && tutorSearchInput.trim() && tutoresOptions.length === 0) {
            <p class="absolute z-10 w-full mt-1 px-4 py-2 bg-white border border-gray-200 rounded-xl shadow text-sm text-gray-500">
              Nenhum tutor encontrado.
            </p>
          }
        </div>
        <div class="pt-4 flex flex-col sm:flex-row gap-3">
          <button
            type="submit"
            [disabled]="saveLoading$ | async"
            class="inline-flex items-center justify-center gap-2 px-4 py-3 sm:py-2.5 rounded-xl bg-petrack text-white font-medium hover:bg-petrack-dark disabled:opacity-50 min-h-[44px]"
          >
            <lucide-icon name="save" [size]="18" />
            {{ isEdit() ? 'Salvar' : 'Cadastrar' }}
          </button>
          <a
            routerLink="/pets"
            class="text-center px-4 py-3 sm:py-2.5 rounded-xl border border-gray-200 text-gray-700 hover:bg-gray-50 min-h-[44px] flex items-center justify-center"
          >
            Cancelar
          </a>
        </div>
      </form>
    </div>
  </div>
</div>
